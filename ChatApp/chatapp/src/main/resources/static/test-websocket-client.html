<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chat App Test Client (Full Status)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
    }

    .panel {
      padding: 10px;
      border-bottom: 1px solid #ccc;
    }

    #login-panel, #app-panel {
      padding: 10px;
    }

    #app-container {
      flex: 1;
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }

    #left-panel {
      width: 30%;
      display: flex;
      flex-direction: column;
      padding-right: 10px;
      overflow-y: auto;
    }

    #right-panel {
      width: 70%;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #ccc;
      padding-left: 10px;
      overflow: hidden;
    }

    #contacts-list {
      list-style: none;
      padding: 0;
      overflow-y: auto;
      flex-grow: 1;
    }

    #contacts-list li {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    #contacts-list li:hover {
      background: #f0f0f0;
    }

    #contacts-list li.active {
      background: #d0e0ff;
    }

    #contacts-list .status {
      float: right;
      font-size: 0.8em;
      color: #888;
    }

    #messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }

    .message {
      padding: 5px 10px;
      margin-bottom: 5px;
      border-radius: 5px;
      max-width: 70%;
      word-wrap: break-word;
    }

    .sent {
      background: #dcf8c6;
      align-self: flex-end;
    }

    .received {
      background: #fff;
      align-self: flex-start;
      border: 1px solid #eee;
    }

    .msg-status {
      font-size: 0.7em;
      color: gray;
      text-align: right;
      display: block;
      margin-top: 2px;
    }

    .tick-read {
      color: #4fc3f7 !important;
    }

    #message-form {
      display: flex;
    }

    #message-form input {
      flex-grow: 1;
      padding: 8px;
      margin-right: 5px;
    }

    #message-form button {
      padding: 8px;
    }

    #log-panel {
      height: 160px;
      background: #333;
      color: lime;
      font-family: monospace;
      padding: 10px;
      overflow-y: auto;
      border-top: 2px solid #222;
    }
  </style>
</head>
<body>

<div id="login-panel" class="panel">
    <h3>1. Login / Register</h3>
    <input type="text" id="mobile" placeholder="Mobile Number (e.g., 111)" />
    <input type="text" id="name" placeholder="Display Name" />
    <button onclick="login()">Login & Connect</button>
    <div id="status">Status: Disconnected</div>
</div>

<div id="app-panel" style="display: none; flex-grow: 1; flex-direction: column; height: 100%;">
    <div id="app-container">
        <div id="left-panel">
            <h3>Contacts</h3>
            <button onclick="syncContacts()">Sync Contacts</button>
            <textarea id="contact-numbers" placeholder="Enter mobile numbers, one per line (e.g., 222)"></textarea>
            <ul id="contacts-list"></ul>
        </div>

        <div id="right-panel">
            <h3 id="chat-with">Select a contact to chat</h3>
            <div id="messages"></div>
            <form id="message-form" onsubmit="sendMessage(event)">
                <input type="text" id="message" placeholder="Type a message..." autocomplete="off"/>
                <button type="submit">Send</button>
            </form>
        </div>
    </div>
</div>

<div id="log-panel">
    <h4>Event Log</h4>
    <pre id="log"></pre>
</div>

<script>
    let stompClient = null;
    let token = null;
    let currentUserId = null;
    let selectedContactId = null;
    let contactStatusCache = {};
    let unsentMessageQueue = [];

    function log(message) {
        document.getElementById('log').innerHTML += `> ${new Date().toLocaleTimeString()}: ${message}\n`;
        document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
    }

    function login() {
        const mobile = document.getElementById('mobile').value;
        const displayName = document.getElementById('name').value;
        if (!mobile || !displayName) {
            log("Mobile Number and Display Name are required.");
            return;
        }
        log(`Attempting login for ${mobile}...`);

        fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mobileNumber: mobile, displayName: displayName })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Login failed with status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.token) {
                token = data.token;
                currentUserId = data.userId;
                log(`Login successful. User ID: ${currentUserId}`);
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('app-panel').style.display = 'flex';
                connect();
            } else { log('Login failed: No token received.'); }
        }).catch(err => log(`Login error: ${err}`));
    }

    // ✅ NEW FUNCTION TO CALL THE SYNC ENDPOINT
    function syncOfflineMessages() {
        log('Client is ready, telling server to sync messages.');
        fetch('/api/messages/sync', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        }).catch(err => log(`Message sync error: ${err}`));
    }

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        const headers = {'Authorization': `Bearer ${token}`};

        stompClient.connect(headers, (frame) => {
            document.getElementById('status').innerText = 'Status: Connected';
            log('WebSocket Connected!');

            // First, send any messages that were queued while offline
            sendQueuedMessages();

            // Then, set up all subscriptions
            stompClient.subscribe(`/user/${currentUserId}/queue/messages`, (message) => {
                const msgDto = JSON.parse(message.body);
                log(`Message received from ${msgDto.senderId}`);
                sendBulkStatusUpdate([msgDto.id], 'DELIVERED', msgDto.senderId);
                if (msgDto.senderId === selectedContactId) {
                    displayMessage(msgDto, 'received');
                    sendBulkStatusUpdate([msgDto.id], 'READ', msgDto.senderId);
                }
            });

            stompClient.subscribe(`/user/${currentUserId}/queue/status`, (message) => {
                const statusUpdate = JSON.parse(message.body);
                log(`Received status update for ${statusUpdate.messageIds.length} message(s) -> ${statusUpdate.status}`);
                statusUpdate.messageIds.forEach(id => {
                    log(`Calling updateMessageStatusTick method`);
                    updateMessageStatusTick(id, statusUpdate.status);
                });
            });

            // ✅ NEW: Subscription for SENT acknowledgement
            stompClient.subscribe(`/user/${currentUserId}/queue/sent-ack`, (message) => {
                const ack = JSON.parse(message.body);
                log(`Received sent-ack for tempId ${ack.tempId}, permanentId is ${ack.permanentId}`);

                // Find the message element by its temporary ID
                const msgElement = document.getElementById(`msg-${ack.tempId}`);
                if (msgElement) {
                    // Update the message element's ID to the permanent one
                    msgElement.id = `msg-${ack.permanentId}`;
                }

                // Find the status element by its temporary ID
                const statusElement = document.getElementById(`status-${ack.tempId}`);
                if (statusElement) {
                    // Update its ID to the permanent one
                    statusElement.id = `status-${ack.permanentId}`;
                    // Update the tick to SENT (✓)
                    updateMessageStatusTick(ack.permanentId, 'SENT');
                }
            });

            stompClient.subscribe('/topic/presence', (message) => processPresenceUpdate(JSON.parse(message.body)));
            stompClient.subscribe(`/user/${currentUserId}/queue/presence`, (message) => processPresenceUpdate(JSON.parse(message.body)));

            // ✅ FINALLY, AFTER EVERYTHING IS SET UP, CALL THE SYNC ENDPOINT
            syncOfflineMessages();

        }, (error) => {
            log(`Connection error: ${error}`);
            document.getElementById('status').innerText = 'Status: Disconnected';
            stompClient = null;
        });
    }

    function sendMessage(event) {
        event.preventDefault();
        const content = document.getElementById('message').value;
        if (!content || !selectedContactId) return;

        const tempId = `unsent-${Date.now()}`;
        const chatMessage = {
            id: tempId,
            senderId: currentUserId,
            receiverId: selectedContactId,
            content: content,
            status: 'UNSENT',
            timestamp: new Date().toISOString()
        };

        if (stompClient && stompClient.connected) {
            stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(chatMessage));
            chatMessage.status = 'SENT';
        } else {
            log('Offline. Queuing message.');
            unsentMessageQueue.push(chatMessage);
        }

        displayMessage(chatMessage, 'sent');
        document.getElementById('message').value = '';
    }

    function sendQueuedMessages() {
        if (unsentMessageQueue.length === 0) return;
        log(`Sending ${unsentMessageQueue.length} queued messages...`);

        unsentMessageQueue.forEach(msg => {
            stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(msg));
            updateMessageStatusTick(msg.id, 'SENT');
        });
        unsentMessageQueue = [];
    }

    function sendBulkStatusUpdate(messageIds, status, senderId) {
        if (!stompClient || !stompClient.connected || messageIds.length === 0) return;
        log(`Sending bulk status update for ${messageIds.length} message(s) to ${status}`);
        const update = { messageIds, status, senderId };
        stompClient.send('/app/chat.updateStatus', {}, JSON.stringify(update));
    }

    function fetchMessages(otherUserId) {
        fetch(`/api/messages?userId=${otherUserId}`, { headers: { 'Authorization': `Bearer ${token}` }})
        .then(response => response.json())
        .then(messages => {
            document.getElementById('messages').innerHTML = '';
            const unreadMessageIds = [];
            messages.forEach(msg => {
                const type = msg.senderId === currentUserId ? 'sent' : 'received';
                displayMessage(msg, type);
                if (type === 'received' && msg.status !== 'READ') {
                    unreadMessageIds.push(msg.id);
                }
            });
            if (unreadMessageIds.length > 0) {
                sendBulkStatusUpdate(unreadMessageIds, 'READ', otherUserId);
            }
        });
    }

    function displayMessage(msg, type) {
        const messagesDiv = document.getElementById('messages');
        const messageEle = document.createElement('div');
        messageEle.className = `message ${type}`;
        messageEle.id = `msg-${msg.id}`;

        let statusTickHtml = '';
        if (type === 'sent') {
            statusTickHtml = `<span class="msg-status" id="status-${msg.id}"></span>`;
        }

        messageEle.innerHTML = `${msg.content} ${statusTickHtml}`;
        messagesDiv.appendChild(messageEle);
        updateMessageStatusTick(msg.id, msg.status);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function updateMessageStatusTick(messageId, status) {
        const statusEl = document.getElementById(`status-${messageId}`);
        if (!statusEl) return;

        let tick = '';
        if (status === 'UNSENT') tick = '🕒';
        if (status === 'SENT') tick = '✓';
        if (status === 'DELIVERED') tick = '✓✓';
        if (status === 'READ') tick = '✓✓<span class="tick-read">✓</span>';

        statusEl.innerHTML = tick;
    }

    function syncContacts() {
        const numbers = document.getElementById('contact-numbers').value.split('\n').filter(n => n);
        fetch('/api/contacts/sync', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ contacts: numbers })
        })
        .then(response => response.json())
        .then(contacts => {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '';
            contacts.forEach(contact => {
                const currentStatus = contactStatusCache[contact.userId] || 'OFFLINE';
                const statusColor = currentStatus === 'ONLINE' ? 'green' : '#888';
                const item = document.createElement('li');
                item.dataset.id = contact.userId;
                item.dataset.name = contact.displayName;
                item.innerHTML = `${contact.displayName} (${contact.mobileNumber}) <span class="status" id="contact-status-${contact.userId}" style="color: ${statusColor};">${currentStatus}</span>`;
                item.onclick = () => selectContactToChat(contact.userId, contact.displayName);
                list.appendChild(item);
            });
        });
    }
    function selectContactToChat(contactId, displayName) { selectedContactId = contactId; document.getElementById('chat-with').innerText = `Chat with ${displayName}`; document.querySelectorAll('#contacts-list li').forEach(li => li.classList.remove('active')); document.querySelector(`#contacts-list li[data-id='${contactId}']`).classList.add('active'); fetchMessages(contactId); }
    function processPresenceUpdate(statusUpdate) { log(`Presence: User ${statusUpdate.userId} is ${statusUpdate.status}`); contactStatusCache[statusUpdate.userId] = statusUpdate.status; updateContactStatus(statusUpdate.userId, statusUpdate.status); }
    function updateContactStatus(userId, status) { const statusElement = document.getElementById(`contact-status-${userId}`); if (statusElement) { statusElement.innerText = status; statusElement.style.color = status === 'ONLINE' ? 'green' : '#888'; } }

    document.addEventListener('DOMContentLoaded', (event) => {
        document.getElementById('login-btn').addEventListener('click', login);
    });
</script>
</body>
</html>
