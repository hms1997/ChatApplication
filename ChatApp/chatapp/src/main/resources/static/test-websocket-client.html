<!DOCTYPE html>
<html>
<head>
    <title>Chat App Test Client</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        .panel { border: 1px solid #ccc; padding: 10px; margin: 5px; border-radius: 5px; }
        #login-panel, #app-panel { display: flex; flex-direction: column; }
        #app-panel { flex-grow: 1; display: none; flex-direction: row; }
        #left-panel { width: 30%; display: flex; flex-direction: column; }
        #right-panel { width: 70%; display: flex; flex-direction: column; border-left: 1px solid #ccc; padding-left: 10px; }
        #contacts-list { list-style: none; padding: 0; }
        #contacts-list li { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
        #contacts-list li:hover { background: #f0f0f0; }
        #contacts-list li.active { background: #d0e0ff; }
        #contacts-list .status { float: right; font-size: 0.8em; color: #888; }
        #messages { flex-grow: 1; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .message { padding: 5px; margin-bottom: 5px; border-radius: 5px; max-width: 70%; }
        .sent { background: #dcf8c6; align-self: flex-end; }
        .received { background: #fff; align-self: flex-start; border: 1px solid #eee; }
        #messages-container { display: flex; flex-direction: column; }
        #log-panel { height: 150px; overflow-y: scroll; background: #333; color: #lime; font-family: monospace; padding: 10px; }
        input, button { padding: 8px; margin: 5px 0; }
    </style>
</head>
<body>

<div id="login-panel" class="panel">
    <h3>1. Login / Register</h3>
    <input type="text" id="mobile" placeholder="Mobile Number (e.g., 111)" />
    <input type="text" id="name" placeholder="Display Name" />
    <button onclick="login()">Login & Connect</button>
    <div id="status">Status: Disconnected</div>
</div>

<div id="app-panel" class="panel">
    <div id="left-panel">
        <h3>Contacts</h3>
        <button onclick="syncContacts()">Sync Contacts</button>
        <textarea id="contact-numbers" placeholder="Enter mobile numbers, one per line (e.g., 222)"></textarea>
        <ul id="contacts-list"></ul>
    </div>
    <div id="right-panel">
        <h3 id="chat-with">Select a contact to chat</h3>
        <div id="messages-container"><div id="messages"></div></div>
        <form id="message-form" onsubmit="sendMessage(event)">
            <input type="text" id="message" placeholder="Type a message..." autocomplete="off"/>
            <button type="submit">Send</button>
        </form>
    </div>
</div>

<div id="log-panel">
    <h3>Event Log</h3>
    <pre id="log"></pre>
</div>


<script>
    let stompClient = null;
    let token = null;
    let currentUserId = null;
    let selectedContactId = null;
    // ✅ 1. ADD THE CACHE OBJECT HERE
    let contactStatusCache = {};

    function log(message) {
        const logEle = document.getElementById('log');
        logEle.innerHTML += `> ${message}\n`;
        logEle.scrollTop = logEle.scrollHeight;
    }

    function login() {
        const mobile = document.getElementById('mobile').value;
        const displayName = document.getElementById('name').value;
        log(`Attempting login for ${mobile}...`);

        fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mobileNumber: mobile, displayName: displayName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.token) {
                token = data.token;
                currentUserId = data.userId;
                log(`Login successful. User ID: ${currentUserId}`);
                log(`Token: ${token.substring(0, 15)}...`);
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('app-panel').style.display = 'flex';
                connect();
            } else {
                log('Login failed.');
            }
        }).catch(err => log(`Login error: ${err}`));
    }

    // ✅ NEW: A shared handler for processing any status update
    function processPresenceUpdate(statusUpdate) {
        log(`Presence update: User ${statusUpdate.userId} is ${statusUpdate.status}`);
        // ALWAYS UPDATE THE CACHE
        contactStatusCache[statusUpdate.userId] = statusUpdate.status;
        // Then, attempt to update the UI if the element exists
        updateContactStatus(statusUpdate.userId, statusUpdate.status);
    }

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        const headers = {'Authorization': `Bearer ${token}`};

        stompClient.connect(headers, (frame) => {
            document.getElementById('status').innerText = 'Status: Connected';
            log('WebSocket Connected!');

            // Subscribe to private messages
            stompClient.subscribe(`/user/${currentUserId}/queue/messages`, (message) => {
                const chatMessage = JSON.parse(message.body);
                log(`Message received from ${chatMessage.senderId}: ${chatMessage.content}`);
                if (chatMessage.senderId === selectedContactId) {
                    displayMessage(chatMessage, 'received');
                }
            });

            // ✅ SUBSCRIBE TO PUBLIC PRESENCE UPDATES
            stompClient.subscribe('/topic/presence', (message) => {
                processPresenceUpdate(JSON.parse(message.body));
            });

            // ✅ SUBSCRIBE TO PRIVATE PRESENCE BACKFILL
            stompClient.subscribe(`/user/${currentUserId}/queue/presence`, (message) => {
                processPresenceUpdate(JSON.parse(message.body));
            });

        }, (error) => {
            log(`Connection error: ${error}`);
            document.getElementById('status').innerText = 'Status: Error';
        });
    }

    function syncContacts() {
        const numbers = document.getElementById('contact-numbers').value.split('\n').filter(n => n);
        log(`Syncing contacts: ${numbers}`);
        fetch('/api/contacts/sync', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ contacts: numbers })
        })
        .then(response => response.json())
        .then(contacts => {
            log(`Found ${contacts.length} registered contacts.`);
            const list = document.getElementById('contacts-list');
            list.innerHTML = '';
            contacts.forEach(contact => {
                // ✅ 3. READ FROM THE CACHE WHEN CREATING THE ELEMENT
                const currentStatus = contactStatusCache[contact.userId] || 'OFFLINE';
                const statusColor = currentStatus === 'ONLINE' ? 'green' : '#888';

                const item = document.createElement('li');
                item.dataset.id = contact.userId;
                item.dataset.name = contact.displayName;

                // Use the retrieved status and color right away
                item.innerHTML = `${contact.displayName} (${contact.mobileNumber}) <span class="status" id="status-${contact.userId}" style="color: ${statusColor};">${currentStatus}</span>`;

                item.onclick = () => selectContactToChat(contact.userId, contact.displayName);
                list.appendChild(item);
            });
        }).catch(err => log(`Contact sync error: ${err}`));
    }

    function updateContactStatus(userId, status) {
        const statusElement = document.getElementById(`status-${userId}`);
        if (statusElement) {
            statusElement.innerText = status;
            statusElement.style.color = status === 'ONLINE' ? 'green' : '#888';
        }
    }

    function selectContactToChat(contactId, displayName) {
        selectedContactId = contactId;
        document.getElementById('chat-with').innerText = `Chat with ${displayName}`;
        document.querySelectorAll('#contacts-list li').forEach(li => li.classList.remove('active'));
        document.querySelector(`#contacts-list li[data-id='${contactId}']`).classList.add('active');
        fetchMessages(contactId);
    }

    function fetchMessages(otherUserId) {
        log(`Fetching messages for user ${otherUserId}...`);
        fetch(`/api/messages?userId=${otherUserId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(response => response.json())
        .then(messages => {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            messages.forEach(msg => {
                const type = msg.senderId === currentUserId ? 'sent' : 'received';
                displayMessage(msg, type);
            });
        }).catch(err => log(`Error fetching messages: ${err}`));
    }

    function sendMessage(event) {
        event.preventDefault();
        const content = document.getElementById('message').value;
        if (content && stompClient && selectedContactId) {
            const chatMessage = {
                senderId: currentUserId,
                receiverId: selectedContactId,
                content: content,
                timestamp: new Date().toISOString()
            };
            stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(chatMessage));
            log(`Message sent to ${selectedContactId}: ${content}`);
            displayMessage(chatMessage, 'sent');
            document.getElementById('message').value = '';
        }
    }

    function displayMessage(msg, type) {
        const messagesDiv = document.getElementById('messages');
        const messageEle = document.createElement('div');
        messageEle.className = `message ${type}`;
        messageEle.innerText = msg.content;
        messagesDiv.parentElement.appendChild(messageEle); // Append to container for correct layout
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

</script>
</body>
</html>